





### Quantitative Ecotoxicology, page 85, example 3.3, Backstripping

Get the data from github ([FAST](https://raw.github.com/EDiLD/r-ed/master/quantitative_ecotoxicology/data/p89_FAST.csv) and [MERCURY](https://raw.github.com/EDiLD/r-ed/master/quantitative_ecotoxicology/data/p89_MERCURY.csv)) and read it into R:


```r
MERCURY <- read.table("p89_MERCURY.csv", header = TRUE, sep = ";")
```




```r
MERCURY$LPCI <- log(MERCURY$PCI)
head(MERCURY)
```

```
##   DAY   PCI    LPCI
## 1   3 27400 10.2183
## 2   6 17601  9.7757
## 3  10 12950  9.4689
## 4  14 11157  9.3198
## 5  22  9410  9.1495
## 6  31  9150  9.1215
```


```r
plot(LPCI ~ DAY, data = MERCURY)
abline(v = 22)
```

![plot of chunk p89_raw](figure/p89_raw.png) 


We can identify two compartments on this plot: A slow one after day 22 and a fast one befor day 22.


```r
mod_slow <- lm(LPCI ~ DAY, data = MERCURY[MERCURY$DAY > 22, ])
sum_mod_slow <- summary(mod_slow)
# correction
corr_mod_slow <- exp(sum_mod_slow$sigma^2/2)
MERCURY$PRED <- exp(predict(mod_slow, newdata = MERCURY)) * corr_mod_slow
CB <- exp(coef(mod_slow)[1]) * corr_mod_slow
KCB <- abs(coef(mod_slow)[2])
```

 

```r
MERCURY$ERROR <- MERCURY$PCI - MERCURY$PRED
```



```r
mod_fast <- lm(log(ERROR) ~ DAY, data = MERCURY[MERCURY$DAY <= 22, ])
```

```
## Warning: NaNs produced
```

```r
# na.omit for negative value
sum_mod_fast <- summary(mod_fast)
corr_mod_fast <- exp(sum_mod_fast$sigma^2/2)
CA <- exp(coef(mod_fast)[1]) * corr_mod_fast
KCA <- abs(coef(mod_fast)[2])
```



```r
plot(LPCI ~ DAY, data = MERCURY)
abline(mod_slow)
abline(mod_fast, lty = "dotted")
legend("topright", c("slow", "backstripped-fast"), lty = c("solid", "dashed"), 
    cex = 0.8)
```

![plot of chunk p89_backstripped](figure/p89_backstripped.png) 




```r
nls_mod1 <- nls(PCI ~ CA * exp(-KCA * DAY) + CB * exp(-KCB * DAY), 
                data = MERCURY, 
                algorithm = "port",    # to use the bonds
                start = list(KCB = KCB, KCA = KCA, CB = CB, CA = CA),
                lower = c(0, 0, 5000, 20000), 
                upper = c(1, 1, 20000, 45000))

plot(PCI ~ DAY, data = MERCURY)
# smooth line
pred_nls_mod1 <- predict(nls_mod1, newdata = data.frame(DAY = seq(0,100, 1)))
lines(seq(0,100, 1), pred_nls_mod1)
```

![plot of chunk p89_nls](figure/p89_nls.png) 

```r

summary(nls_mod1)
```

```
## 
## Formula: PCI ~ CA * exp(-KCA * DAY) + CB * exp(-KCB * DAY)
## 
## Parameters:
##     Estimate Std. Error t value Pr(>|t|)    
## KCB 1.19e-02   1.41e-03    8.45  3.9e-06 ***
## KCA 2.97e-01   4.47e-02    6.66  3.6e-05 ***
## CB  1.22e+04   8.58e+02   14.27  1.9e-08 ***
## CA  3.79e+04   4.82e+03    7.86  7.7e-06 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 
## 
## Residual standard error: 701 on 11 degrees of freedom
## 
## Algorithm "port", convergence message: relative convergence (4)
```






Code and data are available at my [github-repo](https://github.com/EDiLD/r-ed/tree/master/quantitative_ecotoxicology) under file name 'p89'.
